<!DOCTYPE html>
<html>
<head>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, user-scalable=no,
		initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />

	<meta http-equiv="pragma" content="no-cache" />
	<meta http-equiv="expires" content="-1" />

	<title>Evothings Viewer</title>

	<style>
		@import 'ui/css/evothings-app.css';
	</style>

	<style>
	input
	{
		border: 1px solid #aaaaaa !important;
		width: 100% !important;
	}
	</style>

</head>

<body>

	<div id="screen-main">
		<h1>Evothings Viewer</h1>

		<div id="login-ui">
			<button id="button-login" class="small charcoal">
				Login
			</button>

			<button id="button-logout" class="small charcoal">
				Logout
			</button>
		</div>

	</div>

	<script src="https://cdn.auth0.com/js/lock/10.8/lock.min.js"></script>
	<script src="libs/jquery/jquery-3.1.1.min.js"></script>
	<xscript src="app.js"></xscript>

<script>
//python -m SimpleHTTPServer 8000

var serverAddress = 'http://localhost:2000'

function initialize()
{
	var lock = new Auth0Lock(
		'ik5CtR3dBIIHPUvJ7pRK7lG6x2252FeB', 
		'mikael-evothings.eu.auth0.com',
		{ auth: { 
			sso: false,
			responseType: 'token',
			redirectUrl: 'http://localhost:8000/' } })

	var buttonLogin = document.getElementById('button-login')
	var buttonLogout = document.getElementById('button-logout')

	var clientID = localStorage.getItem('hyper-clientid')
	if (!clientID)
	{
		clientID = generateUUID()
		localStorage.setItem('hyper-clientid', clientID)
	}

	buttonLogin.addEventListener('click', function() 
	{
		lock.show();
	});

	buttonLogout.addEventListener('click', function() 
	{
		lock.show();
	});

	lock.on('authenticated', function(authResult) 
	{
		console.log('authenticated')

		console.log('token: ' + authResult.accessToken)

		sendLoginToServer(clientID, authResult.accessToken)

		lock.getProfile(authResult.idToken, function(error, profile)
		{
			if (error) 
			{
				// Handle error
				console.log('getProfile error: ' + error)
				return
			}
			//localStorage.setItem('id_token', authResult.idToken);
			// Display user information
			console.log('login ok')
			
			console.log('profile:')
			console.log(profile)
			console.log('authResult:')
			console.log(authResult)
			//getUserInfo(authResult.accessToken)

			});
		})
}

/*
function getUserInfo(token)
{
  	console.log('getting userinfo')
	$.ajaxSetup({
		'beforeSend': function(xhr) {
		 	xhr.setRequestHeader('Authorization', 'Bearer ' + token)
		}
	});

	$.getJSON('https://mikael-evothings.eu.auth0.com/userinfo', 
		function(data) {
			console.log('got userinfo:')
			console.log(data)
		});
}
*/

function sendLoginToServer(clientID, token)
{
  	console.log('sendLoginToServer')
	
	var url = serverAddress + '/login-mobile-client/' + clientID + '/' + token
	$.getJSON(url,
		function(data) {
			console.log('sendLoginToServer response:')
			console.log(data)
		});
}

function sendLogoutToServer(clientID)
{
  	console.log('sendLogoutToServer')
	
	var url = serverAddress + '/logout-mobile-client/' + clientID
	$.getJSON(url,
		function(data) {
			console.log('sendLogoutToServer response:')
			console.log(data)
		});
}

// Thanks to http://stackoverflow.com/a/8809472/4940311
function generateUUID()
{
	var d = new Date().getTime()
	return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(
		/[xy]/g,
		function(c)
		{
			var r = (d + Math.random()*16) % 16 | 0
			d = Math.floor(d/16)
			return (c == 'x' ? r : (r&0x3|0x8)).toString(16)
		})
}

initialize()

//https://mikael-evothings.eu.auth0.com/mobile, http://localhost:3000, http://localhost:3001

//file://\*
</script>

</body>
</html>
